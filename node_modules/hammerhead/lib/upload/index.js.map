{"version":3,"sources":["upload/index.js"],"names":[],"mappings":";;;;;;;QA6BgB,MAAM,GAAN,MAAM;QAcA,iBAAiB,GAAjB,iBAAiB;;mBA3CvB,KAAK;;;;wBACA,aAAa;;;;yBACS,eAAe;;;AAG1D,SAAS,WAAW,CAAE,iBAAiB,EAAE,IAAI,EAAE,SAAS,EAAE,QAAQ,EAAE;AAChE,QAAI,QAAQ,GAAG,wBAAc,CAAC;;AAE9B,YAAQ,CAAC,sBAAsB,CAAC,iBAAiB,CAAC,CAAC;AACnD,YAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;;AAGzB,QAAI,KAAK,GAAG,QAAQ,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;AACpD,QAAI,IAAI,GAAI,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;;AAEtC,YAAQ,GAAG,QAAQ,CAAC,MAAM,CAAC,QAAQ,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;;AAE3D,WAAO;AACH,YAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC;AAC7B,YAAI,EAAE;AACF,gBAAI,EAAE,KAAK,CAAC,OAAO,CAAC,cAAc,CAAC;AACnC,gBAAI,EAAE,QAAQ;AACd,gBAAI,EAAE,IAAI,CAAC,MAAM;SACpB;KACJ,CAAC;CACL;;;;AAIM,SAAS,MAAM,CAAE,iBAAiB,EAAE,IAAI,EAAE;AAC7C,QAAI,QAAQ,GAAG,wBAAc,CAAC;;AAE9B,YAAQ,CAAC,sBAAsB,CAAC,iBAAiB,CAAC,CAAC;;AAEnD,QAAI,CAAC,QAAQ,CAAC,QAAQ,EAClB,OAAO,IAAI,CAAC;;AAEhB,YAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;AACzB,YAAQ,CAAC,aAAa,EAAE,CAAC;;AAEzB,WAAO,QAAQ,CAAC,QAAQ,EAAE,CAAC;CAC9B;;AAEM,SAAe,iBAAiB,CAAE,GAAG,EAAE,GAAG;QACzC,IAAI,EACJ,SAAS,EACT,iBAAiB,EACjB,SAAS,EACT,QAAQ,EACR,IAAI;;;;;uBALsB,eA1CzB,SAAS,EA0C0B,GAAG,CAAC;;;AAAxC,oBAAI;AACJ,yBAAS,GAAW,cAAI,KAAK,CAAC,GAAG,CAAC,GAAG,EAAE,IAAI,CAAC;AAC5C,iCAAiB,GAAG,GAAG,CAAC,OAAO,CAAC,cAAc,CAAC;AAC/C,yBAAS,GAAW,SAAS,CAAC,KAAK,CAAC,YAAY,CAAC;AACjD,wBAAQ,GAAY,SAAS,CAAC,KAAK,CAAC,UAAU,CAAC;AAC/C,oBAAI,GAAgB,WAAW,CAAC,iBAAiB,EAAE,IAAI,EAAE,SAAS,EAAE,QAAQ,CAAC;;;;;AAKjF,+BApDgB,eAAe,EAoDf,GAAG,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;;;;;;;CACpC","file":"upload/index.js","sourcesContent":["import URL from 'url';\r\nimport FormData from './form-data';\r\nimport { fetchBody, respondWithJSON } from '../utils/http';\r\n\r\n// Utils\r\nfunction getFileInfo (contentTypeHeader, body, inputName, fileName) {\r\n    var formData = new FormData();\r\n\r\n    formData.parseContentTypeHeader(contentTypeHeader);\r\n    formData.parseBody(body);\r\n\r\n\r\n    var entry = formData.getEntriesByName(inputName)[0];\r\n    var data  = Buffer.concat(entry.body);\r\n\r\n    fileName = fileName.substr(fileName.lastIndexOf('\\\\') + 1);\r\n\r\n    return {\r\n        data: data.toString('base64'),\r\n        info: {\r\n            type: entry.headers['Content-Type'],\r\n            name: fileName,\r\n            size: data.length\r\n        }\r\n    };\r\n}\r\n\r\n\r\n// API\r\nexport function inject (contentTypeHeader, body) {\r\n    var formData = new FormData();\r\n\r\n    formData.parseContentTypeHeader(contentTypeHeader);\r\n\r\n    if (!formData.boundary)\r\n        return null;\r\n\r\n    formData.parseBody(body);\r\n    formData.expandUploads();\r\n\r\n    return formData.toBuffer();\r\n}\r\n\r\nexport async function ie9FileReaderShim (req, res) {\r\n    var body              = await fetchBody(req);\r\n    var parsedUrl         = URL.parse(req.url, true);\r\n    var contentTypeHeader = req.headers['content-type'];\r\n    var inputName         = parsedUrl.query['input-name'];\r\n    var filename          = parsedUrl.query['filename'];\r\n    var info              = getFileInfo(contentTypeHeader, body, inputName, filename);\r\n\r\n    // NOTE: we should skip content type, because IE9 can't\r\n    // handle content with content-type \"application/json\"\r\n    // and trying to download it as a file\r\n    respondWithJSON(res, info, true);\r\n}\r\n\r\n"],"sourceRoot":"../src"}