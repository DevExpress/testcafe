{"version":3,"sources":["utils/content.js"],"names":[],"mappings":"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","file":"utils/content.js","sourcesContent":["import charsetEncoder from 'iconv-lite';\r\nimport Promise from 'promise';\r\nimport zlib from 'zlib';\r\n\r\nvar gzip       = Promise.denodeify(zlib.gzip);\r\nvar deflate    = Promise.denodeify(zlib.deflate);\r\nvar gunzip     = Promise.denodeify(zlib.gunzip);\r\nvar inflate    = Promise.denodeify(zlib.inflate);\r\nvar inflateRaw = Promise.denodeify(zlib.inflateRaw);\r\n\r\n// Const\r\nconst CHARSET_RE      = /(?:^|;)\\s*charset=(.+)(?:;|$)/i;\r\nconst META_CHARSET_RE = /charset ?= ?['\"]?([^ ;\"']*)['\"]?/i;\r\nconst JSON_MIME       = 'application/json';\r\nconst MANIFEST_MIME   = 'text/cache-manifest';\r\nconst CSS_MIME        = 'text/css';\r\n\r\nconst PAGE_MIMES = [\r\n    'text/html',\r\n    'application/xhtml+xml',\r\n    'application/xml',\r\n    'application/x-ms-application'\r\n];\r\n\r\nconst SCRIPT_MIMES = [\r\n    'application/javascript',\r\n    'text/javascript',\r\n    'application/x-javascript'\r\n];\r\n\r\nconst CHARSETS = [\r\n    'iso-8859-1', 'iso-8859-2', 'iso-8859-3', 'iso-8859-4',\r\n    'iso-8859-5', 'iso-8859-6', 'iso-8859-7', 'iso-8859-8',\r\n    'iso-8859-9', 'iso-8859-10', 'iso-8859-11', 'iso-8859-12',\r\n    'iso-8859-13', 'iso-8859-14', 'iso-8859-15', 'iso-8859-16',\r\n    'windows-1250', 'windows-1251', 'windows-1252', 'windows-1253',\r\n    'windows-1254', 'windows-1255', 'windows-1256', 'windows-1257',\r\n    'windows-1258', 'windows-874', 'windows-866', 'koi8-r',\r\n    'koi8-u', 'utf-8', 'utf-16', 'utf-32',\r\n    'shift-jis', 'x-euc', 'big5', 'euc-kr'\r\n];\r\n\r\nconst NORMALIZED_CHARSETS_MAP = CHARSETS.reduce((charsetMap, charset) => {\r\n    charsetMap[getNormalizedCharsetMapKey(charset)] = charset;\r\n    return charsetMap;\r\n}, {});\r\n\r\n\r\nconst DEFAULT_CHARSET = 'iso-8859-1';   // NOTE: HTTP 1.1 specifies ISO-8859-1 as a default charset\r\n                                        // (see: http://www.w3.org/International/O-HTTP-charset.en.php).\r\n\r\n\r\n// Charset\r\nfunction getNormalizedCharsetMapKey (charset) {\r\n    return charset.replace(/-/g, '').toLowerCase();\r\n}\r\n\r\nfunction normalizeCharset (charset) {\r\n    var key = charset ? getNormalizedCharsetMapKey(charset) : null;\r\n    return NORMALIZED_CHARSETS_MAP[key] || DEFAULT_CHARSET;\r\n}\r\n\r\nexport function parseCharset (contentTypeHeader) {\r\n    var charsetMatch = contentTypeHeader && contentTypeHeader.match(CHARSET_RE);\r\n    var charset      = charsetMatch ? charsetMatch[1] : null;\r\n    return normalizeCharset(charset);\r\n}\r\n\r\n// NOTE: parsing charset from meta-tags\r\n// www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#determining-the-character-encoding\r\n// Each <meta> descriptor should contain values of the \"http-equiv\", \"content\" and \"charset\" attributes.\r\n//TODO test it!!!!\r\nexport function parseCharsetFromMeta (metas) {\r\n    var needPragma = null;\r\n    var charset    = null;\r\n\r\n    metas.forEach((attrs) => {\r\n        var shouldParseFromContentAttr = needPragma !== false &&\r\n                                         atts.content &&\r\n                                         attrs.httpEquiv &&\r\n                                         attrs.httpEquiv.toLowerCase() === 'content-type';\r\n\r\n        if (shouldParseFromContentAttr) {\r\n            var charsetMatch = attrs.content.match(META_CHARSET_RE);\r\n\r\n            if (charsetMatch) {\r\n                needPragma = true;\r\n                charset    = charsetMatch[1];\r\n            }\r\n        }\r\n\r\n        if (attrs.charset) {\r\n            needPragma = false;\r\n            charset    = attrs.charset;\r\n        }\r\n    });\r\n\r\n    return normalizeCharset(charset);\r\n}\r\n\r\n\r\n// Content type\r\nexport function isPage (header) {\r\n    header = header.toLowerCase();\r\n\r\n    return PAGE_MIMES.some((mime) => header.indexOf(mime) > -1);\r\n}\r\n\r\nexport function isCSSResource (contentTypeHeader, acceptHeader) {\r\n    return contentTypeHeader.toLowerCase().indexOf(CSS_MIME) > -1 ||\r\n           acceptHeader.toLowerCase() === CSS_MIME;\r\n}\r\n\r\nexport function isScriptResource (contentTypeHeader, acceptHeader) {\r\n    contentTypeHeader = contentTypeHeader.toLowerCase();\r\n    acceptHeader      = acceptHeader.toLowerCase();\r\n\r\n    return SCRIPT_MIMES.some((mime) => contentTypeHeader.indexOf(mime) > -1) ||\r\n           SCRIPT_MIMES.indexOf(acceptHeader) > -1;\r\n}\r\n\r\nexport function isManifest (contentTypeHeader) {\r\n    return contentTypeHeader.toLowerCase().indexOf(MANIFEST_MIME) > -1;\r\n}\r\n\r\nexport function isJSON (contentTypeHeader) {\r\n    return contentTypeHeader.toLowerCase().indexOf(JSON_MIME) > -1;\r\n}\r\n\r\n// Encoding / decoding\r\n\r\n// NOTE: IIS has a bug then it sends 'raw deflate' compressed\r\n// data for 'Deflate' Accept-Encoding header.\r\n// (see: http://zoompf.com/2012/02/lose-the-wait-http-compression)\r\nasync function inflateWithFallback (data) {\r\n    try {\r\n        return await inflate(data);\r\n    }\r\n    catch (err) {\r\n        if (err.code === 'Z_DATA_ERROR')\r\n            return await inflateRaw(data);\r\n\r\n        else\r\n            throw err;\r\n    }\r\n}\r\n\r\nexport async function decodeContent (content, encoding, charset) {\r\n    if (encoding === 'gzip')\r\n        content = await gunzip(content);\r\n\r\n    else if (encoding === 'deflate')\r\n        content = await inflateWithFallback(content);\r\n\r\n    return charsetEncoder.decode(content, charset);\r\n}\r\n\r\nexport async function encodeContent (content, encoding, charset) {\r\n    content = charsetEncoder.encode(content, charset);\r\n\r\n    if (encoding === 'gzip')\r\n        return gzip(content);\r\n\r\n    if (encoding === 'deflate')\r\n        return deflate(content);\r\n\r\n    return content;\r\n}"],"sourceRoot":"../src"}