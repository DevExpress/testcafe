{"version":3,"sources":["injector/index.js"],"names":[],"mappings":"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","file":"injector/index.js","sourcesContent":["import whacko from 'whacko';\r\nimport ERR from './errs';\r\nimport ProcessedJsCache from './processed-js-cache';\r\nimport * as sharedConst from '../../shared/const';\r\nimport pageProc from '../../shared/page_processor';\r\nimport * as contentUtils from '../utils/content';\r\n\r\nconst BODY_CREATED_EVENT_SCRIPT = [\r\n    '<script type=\"text/javascript\" class=\"' + sharedConst.TEST_CAFE_SCRIPT_CLASSNAME + '\">',\r\n    'if (window.Hammerhead)',\r\n    '   window.Hammerhead._raiseBodyCreatedEvent();',\r\n    'var script = document.currentScript || document.scripts[document.scripts.length - 1];',\r\n    'script.parentNode.removeChild(script);',\r\n    '</script>'\r\n].join('\\n');\r\n\r\nvar jsCache = new ProcessedJsCache();\r\n\r\nasync function decode (content, encoding, charset) {\r\n    try {\r\n        var decoded = await contentUtils.decodeContent(content, encoding, charset);\r\n\r\n        return { content: decoded };\r\n    } catch (e) {\r\n        return { err: { code: ERR.INJECTOR_RESOURCE_DECODING_FAILED, encoding: encoding } };\r\n    }\r\n}\r\n\r\nasync function encode (content, encoding, charset) {\r\n    try {\r\n        var encoded = await contentUtils.encodeContent(content, encoding, charset);\r\n\r\n        return { content: encoded };\r\n    } catch (e) {\r\n        return { err: { code: ERR.INJECTOR_RESOURCE_ENCODING_FAILED, encoding: encoding } };\r\n    }\r\n}\r\n\r\nasync function inject (body, encoding, charset, processor, injectionOptions) {\r\n    var decodingResult = await decode(body, encoding, charset);\r\n\r\n    if (decodingResult.err)\r\n        return { err: { code: ERR.INJECTOR_RESOURCE_DECODING_FAILED, encoding: encoding } };\r\n    else {\r\n        var processed = processor(decodingResult.content, charset, injectionOptions);\r\n\r\n        if (processed === null)\r\n            return;\r\n\r\n        if (processed.err)\r\n            return processed;\r\n\r\n        var encodingResult = await encode(processed, encoding, charset);\r\n\r\n        if (encodingResult.err)\r\n            return { err: { code: ERR.INJECTOR_RESOURCE_ENCODING_FAILED, encoding: encoding } };\r\n        else\r\n            return { content: encodingResult.content };\r\n    }\r\n}\r\n\r\nfunction getPageCharset ($) {\r\n    var metas = [];\r\n\r\n    $('meta').each(function (meta) {\r\n        var $meta = $(meta);\r\n\r\n        metas.push({\r\n            httpEquiv: $meta.attr('http-equiv'),\r\n            content:   $meta.attr('content'),\r\n            charset:   $meta.attr('charset')\r\n        });\r\n    });\r\n\r\n    return contentUtils.parseCharsetFromMeta(metas);\r\n}\r\n\r\nfunction injectPageResources ($, injectionOptions) {\r\n    var injection = [];\r\n\r\n    if (injectionOptions.styleUrl) {\r\n        injection.push('<link rel=\"stylesheet\" type=\"text/css\" class=\"');\r\n        injection.push(sharedConst.TEST_CAFE_UI_STYLESHEET_FULL_CLASSNAME);\r\n        injection.push('\"href = \"');\r\n        injection.push(injectionOptions.styleUrl);\r\n        injection.push('\">');\r\n    }\r\n\r\n    if (injectionOptions.scripts) {\r\n        injectionOptions.scripts.forEach(function (scriptUrl) {\r\n            injection.push('<script type=\"text/javascript\" class=\"');\r\n            injection.push(sharedConst.TEST_CAFE_SCRIPT_CLASSNAME);\r\n            injection.push('\" charset=\"UTF-8\" src=\"');\r\n            injection.push(scriptUrl);\r\n            injection.push('\">');\r\n            injection.push('</script>');\r\n        });\r\n    }\r\n\r\n    if (injection.length)\r\n        $('head').prepend(injection.join(''));\r\n}\r\n\r\nfunction getRightCharset ($, defaultCharset, actualCharset) {\r\n    if (!defaultCharset) {\r\n        // NOTE: if the charset doesn't set in server's header and if the charset sets in page's meta tag\r\n        // and isn't equal to the default charset, we restart injecting with the new charset.\r\n        // We returns null if need to restart injection.\r\n        var pageCharset = getPageCharset($);\r\n\r\n        if (pageCharset && (pageCharset !== actualCharset))\r\n            return pageCharset;\r\n    }\r\n\r\n    return '';\r\n}\r\n\r\nfunction changeMetas ($) {\r\n    // TODO: figure out how to emulate the behavior of the tag\r\n    $('meta[name=\"referrer\"][content=\"origin\"]').remove();\r\n    // NOTE: Remove existing compatible meta tag and add a new at the beginning of the head\r\n    $('meta[http-equiv=\"X-UA-Compatible\"]').remove();\r\n    $('head').prepend('<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />');\r\n}\r\n\r\nfunction prepareHtml (html, injectionOptions) {\r\n    if (injectionOptions && injectionOptions.iframeImageSrc)\r\n        return '<html><body><img src=\"' + injectionOptions.iframeImageSrc + '\" /></body></html>';\r\n\r\n    return html;\r\n}\r\n\r\nfunction addBodyCreatedEventScript ($) {\r\n    $('body').prepend(BODY_CREATED_EVENT_SCRIPT);\r\n}\r\n\r\nexport async function injectInPage (body, encoding, deafultCharset, injectionOptions, callback) {\r\n    var htmlProcessor = function (html, actualCharset, injectionOptions) {\r\n        var $   = null;\r\n        var bom = pageProc.getBOM(html);\r\n\r\n        html = bom ? html.replace(bom, '') : html;\r\n\r\n        prepareHtml(html, injectionOptions);\r\n\r\n        try {\r\n            $ = whacko.load(html);\r\n        } catch (parseErrs) {\r\n            return { err: { code: ERR.INJECTOR_DOCUMENT_PARSING_FAILED, msg: parseErrs } };\r\n        }\r\n\r\n        var rightCharset = getRightCharset($, deafultCharset, actualCharset);\r\n\r\n        if (rightCharset) {\r\n            //restart injecting\r\n            inject(body, encoding, rightCharset, htmlProcessor, injectionOptions, callback);\r\n        }\r\n        else {\r\n            var iframeHtmlProcessor = function (html, callback) {\r\n                var storedIsIframe = injectionOptions.isIFrame;\r\n\r\n                injectionOptions.isIFrame = true;\r\n\r\n                var result = htmlProcessor(html, actualCharset, injectionOptions);\r\n\r\n                injectionOptions.isIFrame = storedIsIframe;\r\n\r\n                callback(result);\r\n            };\r\n\r\n            pageProc.on(pageProc.HTML_PROCESSING_REQUIRED, iframeHtmlProcessor);\r\n            pageProc.processPage($, injectionOptions.urlReplacer, injectionOptions.crossDomainProxyPort, injectionOptions.isIFrame);\r\n            pageProc.off(pageProc.HTML_PROCESSING_REQUIRED, iframeHtmlProcessor);\r\n\r\n            injectPageResources($, injectionOptions);\r\n            addBodyCreatedEventScript($);\r\n            changeMetas($);\r\n\r\n            return (bom || '') + $.html();\r\n        }\r\n    };\r\n\r\n    callback(await inject(body, encoding, deafultCharset, htmlProcessor, injectionOptions));\r\n}\r\n\r\nexport async function injectInStylesheet (body, encoding, charset, urlReplacer, callback) {\r\n    callback(await inject(body, encoding, charset, function (rawData) {\r\n        return pageProc.processStylesheet(rawData, urlReplacer);\r\n    }));\r\n}\r\n\r\nexport async function injectInScript (body, encoding, charset, callback) {\r\n    callback(await inject(body, encoding, charset, function (rawData) {\r\n        var processedJs = jsCache.pick(rawData);\r\n\r\n        if (!processedJs) {\r\n            processedJs = pageProc.processScript(rawData);\r\n            jsCache.add(rawData, processedJs);\r\n        }\r\n\r\n        return processedJs;\r\n    }));\r\n}\r\n\r\nexport async function injectInManifest (body, encoding, charset, urlReplacer, callback) {\r\n    callback(await inject(body, encoding, charset, function (rawData) {\r\n        return pageProc.processManifest(rawData, urlReplacer);\r\n    }));\r\n}\r\n\r\n//TODO do we really need this?\r\nexport async function injectInJSON (body, encoding, charset, callback) {\r\n    callback(await inject(body, encoding, charset, function (rawData) {\r\n        return pageProc.processScript(rawData, true);\r\n    }));\r\n}"],"sourceRoot":"../src"}