{"version":3,"sources":["resource-processing/index.js"],"names":[],"mappings":"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","file":"resource-processing/index.js","sourcesContent":["import url from 'url';\r\nimport urlUtil from '../../shared/url_util';\r\nimport whacko from 'whacko';\r\nimport * as ERR from '../errs';\r\nimport ProcessedJsCache from './processed-js-cache';\r\nimport * as sharedConst from '../../shared/const';\r\nimport pageProc from '../../shared/page_processor';\r\nimport * as contentUtils from '../utils/content';\r\n\r\nconst BODY_CREATED_EVENT_SCRIPT = [\r\n    `<script type=\"text/javascript\" class=\"${sharedConst.TEST_CAFE_SCRIPT_CLASSNAME}\">\r\n        if (window.Hammerhead)\r\n           window.Hammerhead._raiseBodyCreatedEvent();\r\n        var script = document.currentScript || document.scripts[document.scripts.length - 1];\r\n        script.parentNode.removeChild(script);\r\n    </script>`\r\n].join('\\n');\r\n\r\nvar jsCache = new ProcessedJsCache();\r\n\r\nvar processors = {\r\n    page:       function (html, ctx, actualCharset, processingOpts) {\r\n        processingOpts = processingOpts || getPageProcessingOptions(ctx);\r\n\r\n        var deafultCharset = ctx.contentInfo.charset;\r\n\r\n        var bom = pageProc.getBOM(html);\r\n\r\n        html = bom ? html.replace(bom, '') : html;\r\n\r\n        prepareHtml(html, processingOpts);\r\n\r\n        var $ = whacko.load(html);\r\n\r\n        actualCharset = actualCharset || defaultCharset;\r\n\r\n        var rightCharset = getRightCharset($, deafultCharset, actualCharset);\r\n\r\n        // Restart processing with page charset\r\n        if (rightCharset)\r\n            process(ctx, rightCharset);\r\n        else {\r\n            var iframeHtmlProcessor = function (html, callback) {\r\n                var storedIsIframe = processingOpts.isIFrame;\r\n\r\n                processingOpts.isIFrame = true;\r\n\r\n                var result = processors.page(html, ctx, actualCharset, processingOpts);\r\n\r\n                processingOpts.isIFrame = storedIsIframe;\r\n\r\n                callback(result);\r\n            };\r\n\r\n            pageProc.on(pageProc.HTML_PROCESSING_REQUIRED, iframeHtmlProcessor);\r\n            pageProc.processPage($, processingOpts.urlReplacer, processingOpts.crossDomainProxyPort, processingOpts.isIFrame);\r\n            pageProc.off(pageProc.HTML_PROCESSING_REQUIRED, iframeHtmlProcessor);\r\n\r\n            addPageResources($, processingOpts);\r\n            addBodyCreatedEventScript($);\r\n            changeMetas($);\r\n\r\n            return (bom || '') + $.html();\r\n        }\r\n    },\r\n    script:     function (script) {\r\n        var processedJs = jsCache.pick(script);\r\n\r\n        if (!processedJs) {\r\n            processedJs = pageProc.processScript(script);\r\n            jsCache.add(script, processedJs);\r\n        }\r\n\r\n        return processedJs;\r\n    },\r\n    stylesheet: function (style, ctx) {\r\n        var urlReplacer = getResourceUrlReplacer(ctx);\r\n        return pageProc.processStylesheet(style, urlReplacer);\r\n    },\r\n    manifest:   function (manifest, ctx) {\r\n        var urlReplacer = getResourceUrlReplacer(ctx);\r\n        return pageProc.processManifest(manifest, urlReplacer);\r\n    },\r\n    json:       function (json) {\r\n        return pageProc.processScript(json, true);\r\n    }\r\n};\r\n\r\nfunction getProcessor (ctx) {\r\n    var contentInfo = ctx.contentInfo;\r\n\r\n    if (ctx.isPage || ctx.contentInfo.isIFrameWithImageSrc)\r\n        return processors.page;\r\n\r\n    else if (contentInfo.isCSS)\r\n        return processors.stylesheet;\r\n\r\n    else if (contentInfo.isScript && !ctx.isXhr)\r\n        return processors.script;\r\n\r\n    else if (contentInfo.isManifest)\r\n        return processors.manifest;\r\n\r\n    else if (contentInfo.isJSON)\r\n        return processors.json;\r\n    else\r\n        return null;\r\n}\r\n\r\nasync function decode (content, encoding, charset) {\r\n    try {\r\n        var decoded = await contentUtils.decodeContent(content, encoding, charset);\r\n\r\n        return decoded;\r\n    } catch (e) {\r\n        throw { code: ERR.INJECTOR_RESOURCE_DECODING_FAILED, encoding: encoding };\r\n    }\r\n}\r\n\r\nasync function encode (content, encoding, charset) {\r\n    try {\r\n        var encoded = await contentUtils.encodeContent(content, encoding, charset);\r\n\r\n        return encoded;\r\n    } catch (e) {\r\n        throw { code: ERR.INJECTOR_RESOURCE_ENCODING_FAILED, encoding: encoding };\r\n    }\r\n}\r\n\r\nfunction getResourceUrlReplacer (ctx) {\r\n    return function (resourceUrl, resourceType, baseUrl) {\r\n        // NOTE: resolve base url without a protocol ('//google.com/path' for example)\r\n        baseUrl     = baseUrl ? url.resolve(ctx.dest.url, baseUrl) : '';\r\n        resourceUrl = urlUtil.prepareUrl(resourceUrl);\r\n\r\n        var resolvedUrl = url.resolve(baseUrl || ctx.dest.url, resourceUrl);\r\n\r\n        try {\r\n            return ctx.toProxyUrl(resolvedUrl, false, resourceType);\r\n        } catch (err) {\r\n            return resourceUrl;\r\n        }\r\n    };\r\n}\r\n\r\n// Page processor\r\nfunction getPageProcessingOptions (ctx) {\r\n    return {\r\n        crossDomainProxyPort: ctx.serverInfo.crossDomainPort,\r\n        isIFrame:             ctx.isIFrame,\r\n        styleUrl:             ctx.getInjectableStyles()[0],\r\n        scripts:              ctx.getInjectableScripts(),\r\n        urlReplacer:          getResourceUrlReplacer(ctx),\r\n        isIframeWithImageSrc: ctx.contentInfo && ctx.contentInfo.isIFrameWithImageSrc\r\n    };\r\n}\r\n\r\nfunction getPageCharset ($) {\r\n    var metas = [];\r\n\r\n    $('meta').each(function (meta) {\r\n        var $meta = $(meta);\r\n\r\n        metas.push({\r\n            httpEquiv: $meta.attr('http-equiv'),\r\n            content:   $meta.attr('content'),\r\n            charset:   $meta.attr('charset')\r\n        });\r\n    });\r\n\r\n    return contentUtils.parseCharsetFromMeta(metas);\r\n}\r\n\r\nfunction addPageResources ($, processingOptions) {\r\n    var resources = [];\r\n\r\n    if (processingOptions.styleUrl) {\r\n        resources.push('<link rel=\"stylesheet\" type=\"text/css\" class=\"');\r\n        resources.push(sharedConst.TEST_CAFE_UI_STYLESHEET_FULL_CLASSNAME);\r\n        resources.push('\"href = \"');\r\n        resources.push(processingOptions.styleUrl);\r\n        resources.push('\">');\r\n    }\r\n\r\n    if (processingOptions.scripts) {\r\n        processingOptions.scripts.forEach(function (scriptUrl) {\r\n            resources.push('<script type=\"text/javascript\" class=\"');\r\n            resources.push(sharedConst.TEST_CAFE_SCRIPT_CLASSNAME);\r\n            resources.push('\" charset=\"UTF-8\" src=\"');\r\n            resources.push(scriptUrl);\r\n            resources.push('\">');\r\n            resources.push('</script>');\r\n        });\r\n    }\r\n\r\n    if (resources.length)\r\n        $('head').prepend(resources.join(''));\r\n}\r\n\r\nfunction getRightCharset ($, defaultCharset, actualCharset) {\r\n    if (!defaultCharset) {\r\n        // NOTE: if the charset doesn't set in server's header and if the charset sets in page's meta tag\r\n        // and isn't equal to the default charset, we restart processing with the new charset.\r\n        // We returns null if need to restart procession.\r\n        var pageCharset = getPageCharset($);\r\n\r\n        if (pageCharset && (pageCharset !== actualCharset))\r\n            return pageCharset;\r\n    }\r\n\r\n    return '';\r\n}\r\n\r\nfunction changeMetas ($) {\r\n    // TODO: figure out how to emulate the behavior of the tag\r\n    $('meta[name=\"referrer\"][content=\"origin\"]').remove();\r\n    // NOTE: Remove existing compatible meta tag and add a new at the beginning of the head\r\n    $('meta[http-equiv=\"X-UA-Compatible\"]').remove();\r\n    $('head').prepend('<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />');\r\n}\r\n\r\nfunction prepareHtml (html, processingOpts) {\r\n    if (processingOpts && processingOpts.iframeImageSrc)\r\n        return '<html><body><img src=\"' + processingOpts.iframeImageSrc + '\" /></body></html>';\r\n\r\n    return html;\r\n}\r\n\r\nfunction addBodyCreatedEventScript ($) {\r\n    $('body').prepend(BODY_CREATED_EVENT_SCRIPT);\r\n}\r\n\r\n// API\r\nexport async function process (ctx, customCharset) {\r\n    var body        = ctx.destResBody;\r\n    var contentInfo = ctx.contentInfo;\r\n    var encoding    = contentInfo.encoding;\r\n    var charset     = customCharset || contentInfo.charset;\r\n\r\n    var decoded = await decode(body, encoding, charset);\r\n\r\n    var processor = getProcessor(ctx);\r\n\r\n    if (!processor)\r\n        return body;\r\n\r\n    var processed = processor(decoded, ctx, charset);\r\n\r\n    if (processed === null)\r\n        return;\r\n\r\n    return await encode(processed, encoding, charset);\r\n}"],"sourceRoot":"../src"}